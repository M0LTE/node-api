<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .container.compact {
            padding: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
            margin: 0 0 15px 0;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 8px;
            margin-top: 0;
        }
        h3 {
            color: #444;
            margin: 15px 0 10px 0;
            font-size: 16px;
        }
        p {
            color: #666;
            line-height: 1.6;
            margin: 0 0 15px 0;
        }
        .links {
            margin-top: 0;
        }
        .links a {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 8px 16px;
            background-color: #0066cc;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        .links a:hover {
            background-color: #0052a3;
        }
        .mqtt-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            margin-left: 10px;
        }
        .mqtt-status.connected {
            background-color: #4caf50;
            color: white;
        }
        .mqtt-status.disconnected {
            background-color: #f44336;
            color: white;
        }
        .mqtt-status.connecting {
            background-color: #ff9800;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .topic-card {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #0066cc;
        }
        .topic-card.in-topic {
            border-left-color: #4caf50;
        }
        .topic-card.out-topic {
            border-left-color: #2196f3;
        }
        .topic-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .topic-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
        }
        .stat-value.high {
            color: #4caf50;
        }
        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }
        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .node-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .node-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .node-callsign {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .node-last-seen {
            font-size: 12px;
            opacity: 0.9;
        }
        .node-message-count {
            font-size: 14px;
            opacity: 0.95;
            margin-top: 3px;
        }
        .node-badge.stale {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            opacity: 0.7;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .summary-card {
            background-color: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            flex: 1;
        }
        .summary-number {
            font-size: 36px;
            font-weight: bold;
            color: #0066cc;
        }
        .summary-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* System Metrics Styles */
        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .metric-card.good {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .metric-title {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .metric-subtitle {
            font-size: 11px;
            opacity: 0.8;
        }
        .expandable-section {
            margin-top: 15px;
        }
        .expand-toggle {
            cursor: pointer;
            padding: 10px 15px;
            background-color: #f0f4ff;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s;
        }
        .expand-toggle:hover {
            background-color: #e0e8ff;
        }
        .expand-toggle-title {
            font-weight: 600;
            color: #333;
        }
        .expand-toggle-icon {
            color: #666;
            transition: transform 0.2s;
        }
        .expand-toggle-icon.expanded {
            transform: rotate(90deg);
        }
        .expand-content {
            display: none;
            padding-top: 15px;
        }
        .expand-content.expanded {
            display: block;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .timestamp {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container compact">
        <h1>
            Node API
            <span id="mqttStatus" class="mqtt-status connecting">Connecting...</span>
        </h1>
        <p>Real-time monitoring of the Packet Network</p>
        <div class="links">
            <a href="/links.html">Link Monitor</a>
            <a href="/circuits.html">Circuit Monitor</a>
            <a href="/scalar">API Documentation</a>
            <a href="/openapi/v1.json">OpenAPI Spec</a>
        </div>
    </div>

    <div class="container">
        <h2>Reporting Nodes</h2>
        <p>Nodes actively sending UDP telemetry to this API</p>
        <div class="summary-stats">
            <div class="summary-card">
                <div class="summary-number" id="activeReportingNodesCount">0</div>
                <div class="summary-label">Active Reporting Nodes</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalReportingNodesCount">0</div>
                <div class="summary-label">Total Reporting Nodes</div>
            </div>
        </div>
        <div id="reportingNodesContainer" class="nodes-grid">
            <div class="no-data">Waiting for node data...</div>
        </div>

        <div class="expandable-section">
            <div class="expand-toggle" onclick="toggleNeighborNodes()">
                <span class="expand-toggle-title">📡 Neighbor Nodes (Seen in routing or traffic, not reporting)</span>
                <span class="expand-toggle-icon" id="neighbor-icon">▶</span>
            </div>
            <div class="expand-content" id="neighbor-content">
                <div class="summary-stats">
                    <div class="summary-card">
                        <div class="summary-number" id="activeNeighborNodesCount">0</div>
                        <div class="summary-label">Active Neighbor Nodes</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="totalNeighborNodesCount">0</div>
                        <div class="summary-label">Total Neighbor Nodes</div>
                    </div>
                </div>
                <div id="neighborNodesContainer" class="nodes-grid">
                    <div class="no-data">No neighbor nodes seen</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Real-time MQTT Statistics</h2>
        <div id="statsContainer" class="stats-grid">
            <div class="no-data">Waiting for MQTT data...</div>
        </div>
    </div>

    <div class="container">
        <h2>System Metrics</h2>
        <div id="metricsOverview" class="metrics-overview">
            <div class="no-data">Waiting for metrics data...</div>
        </div>
        
        <div class="expandable-section">
            <div class="expand-toggle" onclick="toggleSection('database')">
                <span class="expand-toggle-title">📊 Database Metrics</span>
                <span class="expand-toggle-icon" id="database-icon">▶</span>
            </div>
            <div class="expand-content" id="database-content"></div>
        </div>

        <div class="expandable-section">
            <div class="expand-toggle" onclick="toggleSection('system')">
                <span class="expand-toggle-title">🖥️ System Resources</span>
                <span class="expand-toggle-icon" id="system-icon">▶</span>
            </div>
            <div class="expand-content" id="system-content"></div>
        </div>

        <div class="expandable-section">
            <div class="expand-toggle" onclick="toggleSection('application')">
                <span class="expand-toggle-title">⚙️ Application Metrics</span>
                <span class="expand-toggle-icon" id="application-icon">▶</span>
            </div>
            <div class="expand-content" id="application-content"></div>
        </div>

        <div class="expandable-section">
            <div class="expand-toggle" onclick="toggleSection('dotnet')">
                <span class="expand-toggle-title">🔧 .NET Runtime</span>
                <span class="expand-toggle-icon" id="dotnet-icon">▶</span>
            </div>
            <div class="expand-content" id="dotnet-content"></div>
        </div>

        <div class="timestamp" id="metricsTimestamp"></div>
    </div>

    <script src="https://unpkg.com/mqtt@5.3.4/dist/mqtt.min.js" 
            integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"
            crossorigin="anonymous"></script>
    <script>
        // Topic statistics tracker
        class TopicStats {
            constructor(topic) {
                this.topic = topic;
                this.messageCount = 0;
                this.timestamps = [];
                this.windowSize = 10000; // 10 second rolling window
            }

            addMessage() {
                const now = Date.now();
                this.messageCount++;
                this.timestamps.push(now);
                
                // Remove timestamps outside the rolling window
                const cutoff = now - this.windowSize;
                this.timestamps = this.timestamps.filter(t => t > cutoff);
            }

            getMessagesPerSecond() {
                if (this.timestamps.length === 0) return 0;
                
                const now = Date.now();
                const cutoff = now - this.windowSize;
                const recentMessages = this.timestamps.filter(t => t > cutoff).length;
                
                return (recentMessages / (this.windowSize / 1000)).toFixed(2);
            }

            getTotalMessages() {
                return this.messageCount;
            }
        }

        // Node tracker
        class NodeTracker {
            constructor() {
                this.nodes = new Map(); // Map of individual callsigns
                this.activeThreshold = 60000; // 60 seconds
            }

            // Extract base callsign without SSID
            getBaseCallsign(callsign) {
                if (!callsign) return null;
                const match = callsign.match(/^([A-Z0-9]+?)(?:-(\d+))?$/i);
                return match ? match[1].toUpperCase() : callsign.toUpperCase();
            }

            updateNode(callsign) {
                const existing = this.nodes.get(callsign);
                if (existing) {
                    existing.lastSeen = Date.now();
                    existing.messageCount++;
                } else {
                    this.nodes.set(callsign, {
                        lastSeen: Date.now(),
                        messageCount: 1,
                        isReporting: false
                    });
                }
            }

            // Mark a node as actively reporting (sending L2Trace with reportFrom)
            markAsReporting(callsign) {
                const existing = this.nodes.get(callsign);
                if (existing) {
                    existing.isReporting = true;
                    existing.lastSeen = Date.now();
                    existing.messageCount++;
                } else {
                    this.nodes.set(callsign, {
                        lastSeen: Date.now(),
                        messageCount: 1,
                        isReporting: true
                    });
                }
            }

            // Get aggregated stats by base callsign
            getAggregatedNodes() {
                const baseCallsigns = new Map();
                
                // Aggregate all SSIDs by base callsign
                for (const [callsign, data] of this.nodes.entries()) {
                    const base = this.getBaseCallsign(callsign);
                    if (!base) continue;
                    
                    if (!baseCallsigns.has(base)) {
                        baseCallsigns.set(base, {
                            baseCallsign: base,
                            ssids: [],
                            messageCount: 0,
                            lastSeen: data.lastSeen,
                            activeCount: 0,
                            isReporting: false
                        });
                    }
                    
                    const aggregated = baseCallsigns.get(base);
                    aggregated.ssids.push(callsign);
                    aggregated.messageCount += data.messageCount;
                    aggregated.lastSeen = Math.max(aggregated.lastSeen, data.lastSeen);
                    
                    // Mark as reporting if ANY SSID is reporting
                    if (data.isReporting) {
                        aggregated.isReporting = true;
                    }
                    
                    // Count active SSIDs
                    if (this.isActive(data.lastSeen)) {
                        aggregated.activeCount++;
                    }
                }
                
                return Array.from(baseCallsigns.values())
                    .sort((a, b) => b.messageCount - a.messageCount);
            }

            getReportingNodes() {
                return this.getAggregatedNodes()
                    .filter(node => node.isReporting);
            }

            getNeighborNodes() {
                return this.getAggregatedNodes()
                    .filter(node => !node.isReporting);
            }

            getActiveReportingNodes() {
                const now = Date.now();
                const cutoff = now - this.activeThreshold;
                
                return this.getReportingNodes()
                    .filter(agg => agg.lastSeen > cutoff);
            }

            getActiveNeighborNodes() {
                const now = Date.now();
                const cutoff = now - this.activeThreshold;
                
                return this.getNeighborNodes()
                    .filter(agg => agg.lastSeen > cutoff);
            }

            isActive(lastSeen) {
                const now = Date.now();
                return (now - lastSeen) < this.activeThreshold;
            }
        }

        const topicStatsMap = new Map();
        const nodeTracker = new NodeTracker();
        let systemMetrics = null;
        const mqttUrl = 'wss://node-api.packet.oarc.uk:443/mqtt/';
        const statusElement = document.getElementById('mqttStatus');
        const statsContainer = document.getElementById('statsContainer');
        const nodesContainer = document.getElementById('nodesContainer');
        const activeNodesCount = document.getElementById('activeNodesCount');
        const totalNodesCount = document.getElementById('totalNodesCount');
        const metricsOverview = document.getElementById('metricsOverview');
        const metricsTimestamp = document.getElementById('metricsTimestamp');

        // Fetch initial node state from API
        async function loadInitialState() {
            try {
                const response = await fetch('/api/nodes');
                if (response.ok) {
                    const nodes = await response.json();
                    console.log(`Loaded ${nodes.length} nodes from API`);
                    
                    // Populate nodeTracker with existing nodes
                    nodes.forEach(node => {
                        const lastSeen = node.lastSeen ? new Date(node.lastSeen).getTime() : Date.now();
                        nodeTracker.nodes.set(node.callsign, {
                            lastSeen: lastSeen,
                            messageCount: node.l2TraceCount || 0
                        });
                    });
                }
            } catch (err) {
                console.error('Error loading initial state:', err);
            }
        }

        // Load initial state before connecting to MQTT
        loadInitialState();

        // Connect to MQTT broker
        const client = mqtt.connect(mqttUrl);

        client.on('connect', () => {
            console.log('Connected to MQTT broker');
            statusElement.textContent = 'Connected';
            statusElement.className = 'mqtt-status connected';
            
            // Subscribe to all topics under in/# and out/#
            client.subscribe('in/#', (err) => {
                if (err) console.error('Error subscribing to in/#:', err);
            });
            client.subscribe('out/#', (err) => {
                if (err) console.error('Error subscribing to out/#:', err);
            });
            client.subscribe('metrics/system', (err) => {
                if (err) console.error('Error subscribing to metrics/system:', err);
            });
        });

        client.on('message', (topic, message) => {
            // Handle system metrics
            if (topic === 'metrics/system') {
                try {
                    systemMetrics = JSON.parse(message.toString());
                    updateMetricsDisplay();
                } catch (err) {
                    console.error('Error parsing metrics:', err);
                }
                return;
            }

            // Get or create stats for this topic
            if (!topicStatsMap.has(topic)) {
                topicStatsMap.set(topic, new TopicStats(topic));
            }
            
            const stats = topicStatsMap.get(topic);
            stats.addMessage();

            // Parse L2Trace messages to extract node information
            if (topic === 'out/L2Trace') {
                try {
                    const data = JSON.parse(message.toString());
                    
                    // Track the reporting node (node that sent this frame)
                    if (data.reportFrom) {
                        nodeTracker.markAsReporting(data.reportFrom);
                    }
                    
                    // Also track source and destination as neighbor nodes
                    // (they'll stay as neighbors unless they later send a reportFrom)
                    if (data.srce && data.srce !== data.reportFrom) {
                        nodeTracker.updateNode(data.srce);
                    }
                    if (data.dest && data.dest !== data.reportFrom) {
                        nodeTracker.updateNode(data.dest);
                    }
                } catch (err) {
                    console.error('Error parsing L2Trace message:', err);
                }
            }
        });

        client.on('error', (err) => {
            console.error('MQTT connection error:', err);
            statusElement.textContent = 'Error';
            statusElement.className = 'mqtt-status disconnected';
        });

        client.on('offline', () => {
            statusElement.textContent = 'Disconnected';
            statusElement.className = 'mqtt-status disconnected';
        });

        client.on('reconnect', () => {
            statusElement.textContent = 'Reconnecting...';
            statusElement.className = 'mqtt-status connecting';
        });

        function formatLastSeen(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatUptime(seconds) {
            if (!seconds) return 'N/A';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        function toggleSection(section) {
            const content = document.getElementById(`${section}-content`);
            const icon = document.getElementById(`${section}-icon`);
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        function toggleNeighborNodes() {
            const content = document.getElementById('neighbor-content');
            const icon = document.getElementById('neighbor-icon');
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        function updateMetricsDisplay() {
            if (!systemMetrics) return;

            // Update overview cards
            const cards = [];
            
            // CPU Card
            if (systemMetrics.system?.cpu_usage_percent !== undefined) {
                const cpu = systemMetrics.system.cpu_usage_percent;
                const cpuClass = cpu > 80 ? 'warning' : cpu < 50 ? 'good' : '';
                cards.push(`
                    <div class="metric-card ${cpuClass}">
                        <div class="metric-title">CPU Usage</div>
                        <div class="metric-value">${cpu.toFixed(1)}%</div>
                        <div class="metric-subtitle">${systemMetrics.system.processor_count || 0} cores</div>
                    </div>
                `);
            }

            // Memory Card
            if (systemMetrics.system?.memory_usage_percent !== undefined) {
                const mem = systemMetrics.system.memory_usage_percent;
                const memClass = mem > 85 ? 'warning' : mem < 60 ? 'good' : '';
                cards.push(`
                    <div class="metric-card ${memClass}">
                        <div class="metric-title">Memory Usage</div>
                        <div class="metric-value">${mem.toFixed(1)}%</div>
                        <div class="metric-subtitle">${formatBytes(systemMetrics.system.used_memory_bytes)} / ${formatBytes(systemMetrics.system.total_memory_bytes)}</div>
                    </div>
                `);
            }

            // Disk Card
            if (systemMetrics.disk?.usage_percent !== undefined) {
                const disk = systemMetrics.disk.usage_percent;
                const diskClass = disk > 80 ? 'warning' : disk < 60 ? 'good' : '';
                cards.push(`
                    <div class="metric-card ${diskClass}">
                        <div class="metric-title">Disk Usage</div>
                        <div class="metric-value">${disk.toFixed(1)}%</div>
                        <div class="metric-subtitle">${formatBytes(systemMetrics.disk.used_bytes)} / ${formatBytes(systemMetrics.disk.total_bytes)}</div>
                    </div>
                `);
            }

            // Database Connections Card
            if (systemMetrics.database?.connections !== undefined) {
                cards.push(`
                    <div class="metric-card">
                        <div class="metric-title">DB Connections</div>
                        <div class="metric-value">${systemMetrics.database.connections}</div>
                        <div class="metric-subtitle">${(systemMetrics.database.queries_per_second || 0).toFixed(2)} QPS</div>
                    </div>
                `);
            }

            // App Memory Card
            if (systemMetrics.application?.memory_working_set_bytes !== undefined) {
                cards.push(`
                    <div class="metric-card">
                        <div class="metric-title">App Memory</div>
                        <div class="metric-value">${formatBytes(systemMetrics.application.memory_working_set_bytes)}</div>
                        <div class="metric-subtitle">${systemMetrics.application.thread_count || 0} threads</div>
                    </div>
                `);
            }

            metricsOverview.innerHTML = cards.join('');

            // Update database details
            if (systemMetrics.database) {
                const db = systemMetrics.database;
                document.getElementById('database-content').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Connections</div>
                            <div class="detail-value">${db.connections || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Threads Running</div>
                            <div class="detail-value">${db.threads_running || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Queries/sec</div>
                            <div class="detail-value">${db.queries_per_second?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Slow Queries</div>
                            <div class="detail-value">${db.slow_queries?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Uptime</div>
                            <div class="detail-value">${formatUptime(db.uptime_seconds)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Buffer Pool</div>
                            <div class="detail-value">${db.innodb_buffer_pool_utilization_pct?.toFixed(1) || 'N/A'}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Data Size</div>
                            <div class="detail-value">${formatBytes(db.total_data_size_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Index Size</div>
                            <div class="detail-value">${formatBytes(db.total_index_size_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tmp Tables (Disk)</div>
                            <div class="detail-value">${db.created_tmp_disk_tables?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Version</div>
                            <div class="detail-value">${db.version || 'N/A'}</div>
                        </div>
                    </div>
                `;
            }

            // Update system details
            if (systemMetrics.system) {
                const sys = systemMetrics.system;
                document.getElementById('system-content').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">CPU Usage</div>
                            <div class="detail-value">${sys.cpu_usage_percent?.toFixed(1) || 'N/A'}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Processor Count</div>
                            <div class="detail-value">${sys.processor_count || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Memory Usage</div>
                            <div class="detail-value">${sys.memory_usage_percent?.toFixed(1) || 'N/A'}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Memory</div>
                            <div class="detail-value">${formatBytes(sys.total_memory_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Available Memory</div>
                            <div class="detail-value">${formatBytes(sys.available_memory_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">System Uptime</div>
                            <div class="detail-value">${formatUptime(sys.uptime_seconds)}</div>
                        </div>
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">OS</div>
                            <div class="detail-value" style="font-size: 14px;">${sys.os_description || 'N/A'}</div>
                        </div>
                    </div>
                `;
            }

            // Update application details
            if (systemMetrics.application) {
                const app = systemMetrics.application;
                document.getElementById('application-content').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Uptime</div>
                            <div class="detail-value">${formatUptime(app.uptime_seconds)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Working Set</div>
                            <div class="detail-value">${formatBytes(app.memory_working_set_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Private Memory</div>
                            <div class="detail-value">${formatBytes(app.memory_private_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Virtual Memory</div>
                            <div class="detail-value">${formatBytes(app.memory_virtual_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Thread Count</div>
                            <div class="detail-value">${app.thread_count || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Handle Count</div>
                            <div class="detail-value">${app.handle_count?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total CPU Time</div>
                            <div class="detail-value">${app.total_processor_time_seconds?.toFixed(1) || 'N/A'}s</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">User CPU Time</div>
                            <div class="detail-value">${app.user_processor_time_seconds?.toFixed(1) || 'N/A'}s</div>
                        </div>
                    </div>
                `;
            }

            // Update .NET details
            if (systemMetrics.dotnet) {
                const dotnet = systemMetrics.dotnet;
                document.getElementById('dotnet-content').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Runtime Version</div>
                            <div class="detail-value">${dotnet.runtime_version || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">GC Heap Size</div>
                            <div class="detail-value">${formatBytes(dotnet.gc_heap_size_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">GC Total Memory</div>
                            <div class="detail-value">${formatBytes(dotnet.gc_total_memory_bytes)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gen 0 Collections</div>
                            <div class="detail-value">${dotnet.gc_gen0_collections?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gen 1 Collections</div>
                            <div class="detail-value">${dotnet.gc_gen1_collections?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gen 2 Collections</div>
                            <div class="detail-value">${dotnet.gc_gen2_collections?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ThreadPool Threads</div>
                            <div class="detail-value">${dotnet.threadpool_thread_count || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ThreadPool Queue</div>
                            <div class="detail-value">${dotnet.threadpool_queue_length?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Completed Items</div>
                            <div class="detail-value">${dotnet.threadpool_completed_items?.toLocaleString() || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Assemblies Loaded</div>
                            <div class="detail-value">${dotnet.assemblies_loaded?.toLocaleString() || 'N/A'}</div>
                        </div>
                    </div>
                `;
            }

            // Update timestamp
            if (systemMetrics.timestamp) {
                const ts = new Date(systemMetrics.timestamp);
                metricsTimestamp.textContent = `Last updated: ${ts.toLocaleTimeString()}`;
            }
        }

        // Update nodes UI every second
        setInterval(() => {
            const reportingNodes = nodeTracker.getReportingNodes();
            const neighborNodes = nodeTracker.getNeighborNodes();
            const activeReporting = nodeTracker.getActiveReportingNodes();
            const activeNeighbor = nodeTracker.getActiveNeighborNodes();

            // Update counts
            document.getElementById('activeReportingNodesCount').textContent = activeReporting.length;
            document.getElementById('totalReportingNodesCount').textContent = reportingNodes.length;
            document.getElementById('activeNeighborNodesCount').textContent = activeNeighbor.length;
            document.getElementById('totalNeighborNodesCount').textContent = neighborNodes.length;

            // Render reporting nodes
            const reportingNodesContainer = document.getElementById('reportingNodesContainer');
            if (reportingNodes.length === 0) {
                reportingNodesContainer.innerHTML = '<div class="no-data">No reporting nodes yet</div>';
            } else {
                const reportingHtml = reportingNodes.map(({ baseCallsign, ssids, lastSeen, messageCount, activeCount }) => {
                    const isActive = nodeTracker.isActive(lastSeen);
                    const staleClass = isActive ? '' : 'stale';
                    
                    // Build SSID summary
                    const ssidCount = ssids.length;
                    const ssidSummary = ssidCount === 1 ? 
                        ssids[0] : 
                        `${ssidCount} SSIDs (${activeCount} active)`;
                    
                    return `
                        <a href="/node.html?callsign=${baseCallsign}" style="text-decoration: none; color: inherit;">
                            <div class="node-badge ${staleClass}">
                                <div class="node-callsign">${baseCallsign}</div>
                                <div class="node-message-count">${messageCount.toLocaleString()} messages</div>
                                <div class="node-last-seen">${ssidSummary}</div>
                                <div class="node-last-seen">${formatLastSeen(lastSeen)}</div>
                            </div>
                        </a>
                    `;
                }).join('');
                reportingNodesContainer.innerHTML = reportingHtml;
            }

            // Render neighbor nodes
            const neighborNodesContainer = document.getElementById('neighborNodesContainer');
            if (neighborNodes.length === 0) {
                neighborNodesContainer.innerHTML = '<div class="no-data">No neighbor nodes seen</div>';
            } else {
                const neighborHtml = neighborNodes.map(({ baseCallsign, ssids, lastSeen, messageCount, activeCount }) => {
                    const isActive = nodeTracker.isActive(lastSeen);
                    const staleClass = isActive ? '' : 'stale';
                    
                    // Build SSID summary
                    const ssidCount = ssids.length;
                    const ssidSummary = ssidCount === 1 ? 
                        ssids[0] : 
                        `${ssidCount} SSIDs (${activeCount} active)`;
                    
                    return `
                        <a href="/node.html?callsign=${baseCallsign}" style="text-decoration: none; color: inherit;">
                            <div class="node-badge ${staleClass}">
                                <div class="node-callsign">${baseCallsign}</div>
                                <div class="node-message-count">${messageCount.toLocaleString()} references</div>
                                <div class="node-last-seen">${ssidSummary}</div>
                                <div class="node-last-seen">${formatLastSeen(lastSeen)}</div>
                            </div>
                        </a>
                    `;
                }).join('');
                neighborNodesContainer.innerHTML = neighborHtml;
            }
        }, 1000);

        // Update stats UI every 500ms
        setInterval(() => {
            if (topicStatsMap.size === 0) return;

            // Sort topics: in/# first, then out/#
            const sortedTopics = Array.from(topicStatsMap.entries()).sort((a, b) => {
                const [topicA] = a;
                const [topicB] = b;
                
                const aIsIn = topicA.startsWith('in/');
                const bIsIn = topicB.startsWith('in/');
                
                if (aIsIn && !bIsIn) return -1;
                if (!aIsIn && bIsIn) return 1;
                return topicA.localeCompare(topicB);
            });

            const html = sortedTopics.map(([topic, stats]) => {
                const mps = stats.getMessagesPerSecond();
                const total = stats.getTotalMessages();
                const isIn = topic.startsWith('in/');
                const cardClass = isIn ? 'in-topic' : 'out-topic';
                const valueClass = parseFloat(mps) > 1 ? 'high' : '';

                return `
                    <div class="topic-card ${cardClass}">
                        <div class="topic-name">${topic}</div>
                        <div class="topic-stats">
                            <div class="stat-row">
                                <span class="stat-label">Messages/sec:</span>
                                <span class="stat-value ${valueClass}">${mps}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value">${total.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            statsContainer.innerHTML = html;
        }, 500);
    </script>
</body>
</html>
